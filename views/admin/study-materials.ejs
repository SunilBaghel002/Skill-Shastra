<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Shastra - Admin Study Materials</title>
    <meta name="description" content="Manage study materials for courses at Skill Shastra.">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/footer.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            color: #1f2937;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }

        .main-content.full {
            margin-left: 0;
        }

        .admin-section {
            padding: 4rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-tag {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            background: rgba(124, 58, 237, 0.2);
            color: #a855f7;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 2.8rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .form-container input,
        .form-container select,
        .form-container textarea {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid #d1d5db;
            border-radius: 8px;
        }

        .form-container button {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .materials-list .material-card {
            background: #f8f9ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .materials-list .material-card a,
        .materials-list .material-card button {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-left: 1rem;
        }

        .materials-list .material-card button.delete {
            background: linear-gradient(135deg, #ef4444, #f87171);
        }

        @media (max-width: 768px) {
            body {
                margin-left: 0;
            }

            .material-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
    </style>
</head>

<body>
    <%- include('../partials/sidebar') %>
        <main class="main-content" id="main-content">
            <section class="admin-section">
                <div class="message-container">
                    <span class="section-tag">Admin Panel</span>
                    <h2 class="section-title">Manage Study Materials</h2>
                    <div class="form-container">
                        <h3>Add New Study Material</h3>
                        <form id="material-form">
                            <input type="text" id="title" placeholder="Material Title" required>
                            <textarea id="description" placeholder="Material Description" required></textarea>
                            <select id="courseId" required>
                                <option value="">Select Course</option>
                                <!-- Courses will be populated here -->
                            </select>
                            <select id="fileType" required>
                                <option value="">Select File Type</option>
                                <option value="pdf">PDF</option>
                                <option value="video">Video</option>
                                <option value="image">Image</option>
                            </select>
                            <input type="file" id="file" accept=".pdf,.mp4,.png,.jpg" required>
                            <button type="submit">Upload Material</button>
                        </form>
                    </div>
                    <div class="materials-list" id="materials-list">
                        <!-- Materials will be populated here -->
                    </div>
                </div>
            </section>
            <%- include('../partials/footer') %>
        </main>
        <script>
            document.addEventListener('DOMContentLoaded', async () => {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user.name || !user.email) {
                    alert('Please log in to access this page.');
                    window.location.href = '/signup?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }

                // Update main content margin
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                if (sidebar && mainContent) {
                    if (sidebar.classList.contains('hidden')) {
                        mainContent.classList.add('full');
                    }
                    sidebar.addEventListener('transitionend', () => {
                        mainContent.classList.toggle('full', sidebar.classList.contains('hidden'));
                    });
                }

                const token = localStorage.getItem('token') || '';

                // Fetch courses for dropdown
                try {
                    const courseResponse = await fetch('/api/study-materials/courses', {
                        headers: { 'Authorization': `Bearer ${token}` },
                    });
                    const courseData = await courseResponse.json();
                    if (courseResponse.ok && courseData.courses) {
                        const courseSelect = document.getElementById('courseId');
                        courseData.courses.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course._id;
                            option.textContent = course.title;
                            courseSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error fetching courses:', error);
                }

                // Fetch study materials
                const fetchMaterials = async () => {
                    try {
                        const response = await fetch('/api/study-materials/admin', {
                            headers: { 'Authorization': `Bearer ${token}` },
                        });
                        const data = await response.json();
                        if (response.ok && data.studyMaterials) {
                            const materialsList = document.getElementById('materials-list');
                            materialsList.innerHTML = '';
                            if (data.studyMaterials.length === 0) {
                                materialsList.innerHTML = '<p>No study materials available.</p>';
                                return;
                            }
                            data.studyMaterials.forEach(material => {
                                const card = document.createElement('div');
                                card.className = 'material-card';
                                card.innerHTML = `
                <div>
                  <h4>${material.title}</h4>
                  <p>${material.description}</p>
                  <p><strong>Course:</strong> ${material.course.title}</p>
                  <p><strong>Type:</strong> ${material.fileType.toUpperCase()}</p>
                  <p><strong>Created by:</strong> ${material.createdBy.name}</p>
                </div>
                <div>
                  <a href="${material.fileUrl}" target="_blank">View</a>
                  <button class="delete" data-id="${material._id}">Delete</button>
                </div>
              `;
                                materialsList.appendChild(card);
                            });

                            // Add delete event listeners
                            document.querySelectorAll('.delete').forEach(button => {
                                button.addEventListener('click', async () => {
                                    if (confirm('Are you sure you want to delete this material?')) {
                                        try {
                                            const response = await fetch(`/api/study-materials/${button.dataset.id}`, {
                                                method: 'DELETE',
                                                headers: { 'Authorization': `Bearer ${token}` },
                                            });
                                            if (response.ok) {
                                                alert('Material deleted successfully.');
                                                fetchMaterials();
                                            } else {
                                                alert('Failed to delete material.');
                                            }
                                        } catch (error) {
                                            console.error('Error deleting material:', error);
                                            alert('An error occurred while deleting the material.');
                                        }
                                    }
                                });
                            });
                        } else {
                            alert('Failed to load study materials.');
                        }
                    } catch (error) {
                        console.error('Error fetching study materials:', error);
                        alert('An error occurred while fetching study materials.');
                    }
                };

                // Initial fetch
                fetchMaterials();

                // Handle form submission
                document.getElementById('material-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData();
                    formData.append('title', document.getElementById('title').value);
                    formData.append('description', document.getElementById('description').value);
                    formData.append('courseId', document.getElementById('courseId').value);
                    formData.append('fileType', document.getElementById('fileType').value);
                    formData.append('file', document.getElementById('file').files[0]);

                    try {
                        const response = await fetch('/api/study-materials', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` },
                            body: formData,
                        });
                        if (response.ok) {
                            alert('Material uploaded successfully.');
                            document.getElementById('material-form').reset();
                            fetchMaterials();
                        } else {
                            alert('Failed to upload material.');
                        }
                    } catch (error) {
                        console.error('Error uploading material:', error);
                        alert('An error occurred while uploading the material.');
                    }
                });
            });
        </script>
        <script src="/js/sidebar.js"></script>
</body>

</html>